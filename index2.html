<!DOCTYPE html>
<html>
	<head>
		<script>
			navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
				
				const pc = new RTCPeerConnection({
					iceServers: [
						{
							urls: 'stun:stun.l.google.com:19302'
						}
					]
				});
				
				pc.onconnectionstatechange = (event) => {
					console.log('pc.onconnectionstatechange');
					console.log(pc.connectionState);
				};
				
				pc.ontrack = () => {
					console.log('pc.ontrack');
				};
				
				pc.onicegatheringstatechange = () => {
					console.log('pc.onicegatheringstatechange');
				};
				
				stream.getTracks().forEach((track) => {
					console.log('--TRACK--');
					pc.addTrack(track, stream);
				});
				

				const socket = new WebSocket('wss://34-220-94-79.lachlanb.me:8080');

				socket.addEventListener('message', function (message) {

					var event = JSON.parse(message.data);
					console.log(event);

					pc.setRemoteDescription({
						type: 'offer',
						sdp: event.directive.payload.offer.value
					}).then(() => {
						return pc.createAnswer();
					}).then((answer) => {
						return pc.setLocalDescription(answer);
					}).then(() => {
						pc.onicecandidate = (event) => {
							// Wait for null candidate (ICE gathering has finished)
							if (!event.candidate) {
								console.log('Null Candidate');
								console.log('sending ' + JSON.stringify(pc.localDescription));
								socket.send(JSON.stringify(pc.localDescription));
							}
						};
					});
				});
			});
		</script>
	</head>
	<body>
	</body>
</html>
